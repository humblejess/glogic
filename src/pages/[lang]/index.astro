---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AbstractShape from '../../components/AbstractShape.astro';
import RankingComponent from '../../components/RankingComponent.vue';
import ScenarioDisplay from '../../components/ScenarioDisplay.vue';
import { supportedLanguages } from '../../utils/i18n';
import { discordConfig } from '../../config/discord';
import en from '../../locales/en.json';
import zhCN from '../../locales/zh-CN.json';
import zhTW from '../../locales/zh-TW.json';
import fr from '../../locales/fr.json';
import es from '../../locales/es.json';

export function getStaticPaths() {
  return supportedLanguages.map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params;
const locales: Record<string, any> = {
  'en': en,
  'zh-CN': zhCN,
  'zh-TW': zhTW,
  'fr': fr,
  'es': es,
};
const t = locales[lang || 'en'] || en;

const options = [
  { id: 'a', key: 'a', title: t.ranking.options.a.title, description: t.ranking.options.a.description },
  { id: 'b', key: 'b', title: t.ranking.options.b.title, description: t.ranking.options.b.description },
  { id: 'c', key: 'c', title: t.ranking.options.c.title, description: t.ranking.options.c.description },
  { id: 'd', key: 'd', title: t.ranking.options.d.title, description: t.ranking.options.d.description },
  { id: 'e', key: 'e', title: t.ranking.options.e.title, description: t.ranking.options.e.description },
  { id: 'f', key: 'f', title: t.ranking.options.f.title, description: t.ranking.options.f.description },
];
---

<BaseLayout title={t.site.title} description={t.site.description}>
  <main class="scroll-smooth">
    <!-- Section 1: Introduction -->
    <section class="flex items-center justify-center py-12 pb-8 px-4 relative overflow-hidden">
      <!-- Decorative background shapes -->
      <AbstractShape type="blob" size="lg" color="primary" position="top-left" opacity={0.1} />
      <AbstractShape type="circle" size="md" color="accent" position="top-right" opacity={0.08} />
      <AbstractShape type="blob" size="md" color="purple" position="bottom-left" opacity={0.08} />
      <AbstractShape type="square" size="sm" color="blue" position="bottom-right" opacity={0.06} />
      
      <div class="container-custom text-center relative z-10">
        <div class="mb-8">
          <div class="inline-block p-4 rounded-2xl bg-gradient-to-br from-primary-100 to-accent-100 mb-6">
            <svg class="w-16 h-16 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
          </div>
        </div>
        
        <h1 class="text-5xl md:text-7xl font-bold mb-6 bg-gradient-to-r from-primary-600 via-accent-500 to-primary-600 bg-clip-text text-transparent animate-gradient">
          {t.intro.title}
        </h1>
        <p class="text-xl md:text-2xl text-gray-700 mb-8 font-medium">
          {t.intro.subtitle}
        </p>
        <div class="max-w-3xl mx-auto mb-12">
          <div class="card bg-white/80 backdrop-blur-sm border-2 border-primary-100">
            <p class="text-lg md:text-xl text-gray-700 leading-relaxed">
              {t.intro.content}
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 2: Ranking -->
    <section id="ranking" class="py-12 px-4 relative overflow-hidden">
      <AbstractShape type="blob" size="md" color="primary" position="top-right" opacity={0.08} />
      <AbstractShape type="circle" size="sm" color="accent" position="bottom-left" opacity={0.06} />
      
      <div class="container-custom relative z-10">
        <RankingComponent 
          client:load
          options={JSON.stringify(options)}
          translations={JSON.stringify(t)}
          currentLang={lang || 'en'}
        />
      </div>
    </section>

    <!-- Section 3: Scenario -->
    <section id="scenario" class="py-12 px-4 relative overflow-hidden">
      <AbstractShape type="blob" size="md" color="primary" position="top-right" opacity={0.08} />
      <AbstractShape type="circle" size="sm" color="accent" position="bottom-left" opacity={0.06} />
      
      <div class="container-custom relative z-10">
        <div class="text-center mb-12">
          <div class="inline-block mb-6">
            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center shadow-lg mx-auto">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
          </div>
          <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-primary-600 to-accent-500 bg-clip-text text-transparent">
            {t.scenario.title}
          </h1>
          <p class="text-xl text-gray-600">{t.scenario.subtitle}</p>
        </div>

        <div class="space-y-8">
          <ScenarioDisplay 
            client:load
            translations={JSON.stringify(t)}
            currentLang={lang || 'en'}
          />
        </div>
      </div>
    </section>

    <!-- Section 4: Gender Therapy Reflection -->
    <section id="genderTherapy" class="py-12 px-4 relative overflow-hidden">
      <AbstractShape type="blob" size="md" color="primary" position="top-right" opacity={0.08} />
      <AbstractShape type="circle" size="sm" color="accent" position="bottom-left" opacity={0.06} />
      
      <div class="container-custom relative z-10">
        <div class="text-center mb-12">
          <div class="inline-block mb-6">
            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center shadow-lg mx-auto">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
              </svg>
            </div>
          </div>
          <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-primary-600 to-accent-500 bg-clip-text text-transparent">
            {t.genderTherapy.title}
          </h1>
          <p class="text-xl text-gray-600">{t.genderTherapy.subtitle}</p>
        </div>

        <div class="max-w-5xl mx-auto">
          {/* Desktop: Table View */}
          <div class="hidden sm:block">
            <table class="w-full border-collapse bg-white rounded-xl shadow-sm">
            <thead>
              <tr class="bg-gradient-to-r from-primary-50 to-accent-50">
                <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-900">{t.genderTherapy.table.project}</th>
                <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-900">{t.genderTherapy.table.freeDemand}</th>
                <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-900">{t.genderTherapy.table.paidDemand}</th>
                <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-900">{t.genderTherapy.table.essence}</th>
              </tr>
            </thead>
            <tbody>
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="border border-gray-300 px-4 py-3 font-semibold text-gray-900">{t.genderTherapy.table.luxuryTravel.project}</td>
                <td class="border border-gray-300 px-4 py-3 text-gray-700">{t.genderTherapy.table.luxuryTravel.freeDemand}</td>
                <td class="border border-gray-300 px-4 py-3 text-gray-700">{t.genderTherapy.table.luxuryTravel.paidDemand}</td>
                <td class="border border-gray-300 px-4 py-3 text-gray-700 italic">{t.genderTherapy.table.luxuryTravel.essence}</td>
              </tr>
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="border border-gray-300 px-4 py-3 font-semibold text-gray-900">{t.genderTherapy.table.cosmetic.project}</td>
                <td class="border border-gray-300 px-4 py-3 text-gray-700">{t.genderTherapy.table.cosmetic.freeDemand}</td>
                <td class="border border-gray-300 px-4 py-3 text-gray-700">{t.genderTherapy.table.cosmetic.paidDemand}</td>
                <td class="border border-gray-300 px-4 py-3 text-gray-700 italic">{t.genderTherapy.table.cosmetic.essence}</td>
              </tr>
              <tr class="hover:bg-primary-50 transition-colors">
                <td class="border border-gray-300 px-4 py-3 font-semibold text-primary-700 bg-primary-50">{t.genderTherapy.table.genderTherapy.project}</td>
                <td class="border border-gray-300 px-4 py-3 text-primary-700 bg-primary-50">
                  <div>{t.genderTherapy.table.genderTherapy.freeDemand}</div>
                  <div class="text-xs mt-1 text-accent-600 font-medium italic">{t.genderTherapy.table.genderTherapy.freeDemandNote}</div>
                </td>
                <td class="border border-gray-300 px-4 py-3 text-primary-700 bg-primary-50">{t.genderTherapy.table.genderTherapy.paidDemand}</td>
                <td class="border border-gray-300 px-4 py-3 text-primary-700 italic font-medium bg-primary-50">{t.genderTherapy.table.genderTherapy.essence}</td>
              </tr>
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="border border-gray-300 px-4 py-3 font-semibold text-gray-900">{t.genderTherapy.table.diabetes.project}</td>
                <td class="border border-gray-300 px-4 py-3 text-gray-700">{t.genderTherapy.table.diabetes.freeDemand}</td>
                <td class="border border-gray-300 px-4 py-3 text-gray-700">{t.genderTherapy.table.diabetes.paidDemand}</td>
                <td class="border border-gray-300 px-4 py-3 text-gray-700 italic">{t.genderTherapy.table.diabetes.essence}</td>
              </tr>
            </tbody>
          </table>
          </div>

          {/* Mobile: Card View */}
          <div class="sm:hidden space-y-4">
            {/* Luxury Travel Card */}
            <div class="card border-2 border-gray-200">
              <div class="font-semibold text-lg mb-3 text-gray-900">{t.genderTherapy.table.luxuryTravel.project}</div>
              <div class="space-y-2 text-sm">
                <div>
                  <span class="font-semibold text-gray-700">{t.genderTherapy.table.freeDemand}:</span>
                  <span class="text-gray-600 ml-2">{t.genderTherapy.table.luxuryTravel.freeDemand}</span>
                </div>
                <div>
                  <span class="font-semibold text-gray-700">{t.genderTherapy.table.paidDemand}:</span>
                  <span class="text-gray-600 ml-2">{t.genderTherapy.table.luxuryTravel.paidDemand}</span>
                </div>
                <div class="pt-2 border-t border-gray-200 italic text-gray-700">
                  {t.genderTherapy.table.luxuryTravel.essence}
                </div>
              </div>
            </div>

            {/* Cosmetic Card */}
            <div class="card border-2 border-gray-200">
              <div class="font-semibold text-lg mb-3 text-gray-900">{t.genderTherapy.table.cosmetic.project}</div>
              <div class="space-y-2 text-sm">
                <div>
                  <span class="font-semibold text-gray-700">{t.genderTherapy.table.freeDemand}:</span>
                  <span class="text-gray-600 ml-2">{t.genderTherapy.table.cosmetic.freeDemand}</span>
                </div>
                <div>
                  <span class="font-semibold text-gray-700">{t.genderTherapy.table.paidDemand}:</span>
                  <span class="text-gray-600 ml-2">{t.genderTherapy.table.cosmetic.paidDemand}</span>
                </div>
                <div class="pt-2 border-t border-gray-200 italic text-gray-700">
                  {t.genderTherapy.table.cosmetic.essence}
                </div>
              </div>
            </div>

            {/* Gender Therapy Card */}
            <div class="card border-2 border-primary-200 bg-primary-50">
              <div class="font-semibold text-lg mb-3 text-primary-700">{t.genderTherapy.table.genderTherapy.project}</div>
              <div class="space-y-2 text-sm">
                <div>
                  <span class="font-semibold text-primary-700">{t.genderTherapy.table.freeDemand}:</span>
                  <span class="text-primary-600 ml-2">{t.genderTherapy.table.genderTherapy.freeDemand}</span>
                  <div class="text-xs mt-1 text-accent-600 font-medium italic">{t.genderTherapy.table.genderTherapy.freeDemandNote}</div>
                </div>
                <div>
                  <span class="font-semibold text-primary-700">{t.genderTherapy.table.paidDemand}:</span>
                  <span class="text-primary-600 ml-2">{t.genderTherapy.table.genderTherapy.paidDemand}</span>
                </div>
                <div class="pt-2 border-t border-primary-200 italic text-primary-700 font-medium">
                  {t.genderTherapy.table.genderTherapy.essence}
                </div>
              </div>
            </div>

            {/* Diabetes Card */}
            <div class="card border-2 border-gray-200">
              <div class="font-semibold text-lg mb-3 text-gray-900">{t.genderTherapy.table.diabetes.project}</div>
              <div class="space-y-2 text-sm">
                <div>
                  <span class="font-semibold text-gray-700">{t.genderTherapy.table.freeDemand}:</span>
                  <span class="text-gray-600 ml-2">{t.genderTherapy.table.diabetes.freeDemand}</span>
                </div>
                <div>
                  <span class="font-semibold text-gray-700">{t.genderTherapy.table.paidDemand}:</span>
                  <span class="text-gray-600 ml-2">{t.genderTherapy.table.diabetes.paidDemand}</span>
                </div>
                <div class="pt-2 border-t border-gray-200 italic text-gray-700">
                  {t.genderTherapy.table.diabetes.essence}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Reflection text below table */}
        <div class="max-w-3xl mx-auto mt-8">
          <div class="card bg-primary-50 border-2 border-primary-200">
            <p class="text-lg md:text-xl text-gray-800 leading-relaxed font-medium">
              {t.genderTherapy.reflection}
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 5: Conclusion -->
    <section id="conclusion" class="py-12 px-4 relative overflow-hidden">
      <AbstractShape type="blob" size="lg" color="primary" position="top-left" opacity={0.08} />
      <AbstractShape type="square" size="md" color="accent" position="bottom-right" opacity={0.06} />
      
      <div class="container-custom relative z-10">
        <div class="text-center mb-12">
          <div class="inline-block mb-6">
            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center shadow-lg mx-auto">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
          <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-primary-600 to-accent-500 bg-clip-text text-transparent">
            {t.conclusion.title}
          </h1>
        </div>

        <div class="max-w-3xl mx-auto">
          <div class="card relative overflow-hidden border-2 border-primary-100">
            <div class="absolute top-0 left-0 w-24 h-24 bg-gradient-to-br from-primary-500/10 to-accent-500/10 rounded-br-full"></div>
            <div class="relative z-10">
              <div class="prose max-w-none">
                <div class="bg-gray-50 rounded-xl p-6 border-l-4 border-primary-500">
                  <p class="text-lg md:text-xl text-gray-700 leading-relaxed">
                    {t.conclusion.content}
                  </p>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- Section 6: Call to Action -->
    <section id="action" class="py-12 px-4 relative overflow-hidden">
      <AbstractShape type="blob" size="md" color="primary" position="top-right" opacity={0.08} />
      <AbstractShape type="circle" size="lg" color="accent" position="bottom-left" opacity={0.06} />
      
      <div class="container-custom relative z-10">
        <div class="text-center mb-12">
          <div class="inline-block mb-6">
            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center shadow-lg mx-auto">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
            </div>
          </div>
          <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-primary-600 to-accent-500 bg-clip-text text-transparent">
            {t.callToAction.title}
          </h1>
          <p class="text-xl text-gray-600">{t.callToAction.subtitle}</p>
        </div>

        <div class="max-w-3xl mx-auto space-y-8">
          <div class="card relative overflow-hidden border-2 border-primary-100">
            <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-primary-500/10 to-accent-500/10 rounded-bl-full"></div>
            <div class="relative z-10">
              <div class="prose max-w-none">
                <div class="bg-gray-50 rounded-xl p-6 border-l-4 border-primary-500 space-y-4">
                  <p class="text-lg md:text-xl text-gray-800 leading-relaxed font-semibold">
                    {t.callToAction.intro}
                  </p>
                  <p class="text-lg md:text-xl text-gray-700 leading-relaxed">
                    {t.callToAction.content}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="card text-center relative overflow-hidden border-2 border-accent-200 bg-gradient-to-br from-white to-accent-50/30">
            <div class="absolute top-0 left-0 w-24 h-24 bg-gradient-to-br from-accent-500/10 to-primary-500/10 rounded-br-full"></div>
            <div class="relative z-10">
              <div class="mb-6">
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-accent-500 to-primary-500 flex items-center justify-center shadow-lg mx-auto">
                  <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33a1.2 1.2 0 0 1-1.2-1.17a1.2 1.2 0 0 1 1.2-1.201a1.2 1.2 0 0 1 1.2 1.2a1.2 1.2 0 0 1-1.2 1.171zm7.974 0a1.2 1.2 0 0 1-1.2-1.17a1.2 1.2 0 0 1 1.2-1.201a1.2 1.2 0 0 1 1.2 1.2a1.2 1.2 0 0 1-1.2 1.171z"/>
                  </svg>
                </div>
              </div>
              <h2 class="text-2xl font-bold mb-4 text-gray-900">{t.callToAction.discord}</h2>
              <p class="text-gray-600 mb-6">{t.callToAction.discordDescription}</p>
              
              {/* Discord Widget (可选) */}
              {discordConfig.enableWidget && discordConfig.widgetUrl && (
                <div class="mb-6 flex justify-center">
                  <iframe 
                    src={discordConfig.widgetUrl}
                    width="350" 
                    height="500" 
                    allowtransparency="true"
                    frameborder="0" 
                    sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"
                    class="rounded-lg shadow-lg"
                  ></iframe>
                </div>
              )}
              
              {/* 加入 Discord 按钮 */}
              <a 
                href={discordConfig.inviteUrl}
                class="btn-primary inline-block shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200"
                target="_blank"
                rel="noopener noreferrer"
              >
                {t.callToAction.joinDiscord || 'Join Discord Server'}
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>

<style>
  @keyframes gradient {
    0%, 100% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
  }
  
  .animate-gradient {
    background-size: 200% auto;
    animation: gradient 3s ease infinite;
  }
</style>

<script>
  // 记录页面访问
  if (typeof window !== 'undefined') {
    // 生成或获取会话ID
    function getSessionId(): string {
      let sessionId = sessionStorage.getItem('session_id');
      if (!sessionId) {
        sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        sessionStorage.setItem('session_id', sessionId);
      }
      return sessionId;
    }
    
    // 获取当前语言
    const currentLang = window.location.pathname.split('/')[1] || 'en';
    const sessionId = getSessionId();
    const pagePath = window.location.pathname;
    
    // 异步发送访问记录，不阻塞页面加载
    fetch('/api/view?path=' + encodeURIComponent(pagePath), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId,
        language: currentLang
      })
    }).catch(err => {
      // 静默失败，不影响用户体验
      console.error('Failed to log page view:', err);
    });
  }
</script>
